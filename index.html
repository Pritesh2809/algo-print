<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ALGORHYTHM'26 – Attendance Sheet</title>

  <style>
    body{ margin:0; font-family:Arial, sans-serif; background:#f3f4f6; padding:20px; }
    .container{ max-width:900px; margin:auto; background:white; padding:20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .header{ text-align:center; margin-bottom:15px; border-bottom: 2px solid #000; padding-bottom: 10px; }
    .header h1{ margin:0; font-size:24px; letter-spacing: 2px; }
    .header p{ margin:4px 0 0; font-size:14px; font-weight: bold; color:#333; }

    .controls{ display:flex; gap:10px; margin-bottom:15px; }
    select, button{ padding:8px 12px; font-size:14px; border: 1px solid #ccc; }
    button{ background:#111827; color:white; border:none; cursor:pointer; }

    table{ width:100%; border-collapse:collapse; font-size:12px; }
    th, td{ border:1px solid #000; padding:6px 8px; text-align:left; }
    th{ background:#f3f4f6; }

    .checkbox{ width:16px; height:16px; border:1px solid #000; margin:auto; }

    /* SIGNATURE SECTION */
    .final-footer {
      margin-top: 30px;
      padding-top: 20px;
      display: flex;
      justify-content: flex-end;
      font-weight: bold;
    }
    .sig-line { border-top: 1px solid #000; width: 200px; text-align: center; margin-top: 40px; }

    @media print{
      body{ background:white; padding:0; }
      .controls{ display:none; }
      .container{ padding:0; box-shadow: none; }
      @page{ size:A4 portrait; margin:15mm; }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>ALGORHYTHM'26</h1>
    <p id="eventTitle">Select an event to generate sheet</p>
  </div>

  <div class="controls">
    <select id="eventSelect"><option value="">Loading Data...</option></select>
    <button onclick="window.print()">Print Sheet</button>
  </div>

  <div id="printArea"></div>
</div>

<script>
  const SHEETS=[
    {id:"1I5r5Zy69lSOB3-0_kjm94Twe20zfU_Xz3oLbmRmXe7A", name:"Form Responses 1"},
    {id:"1QssSb2v6UH1XcNxaBYEBZmGDQKrqH78TtXdm5A8rTa0", name:"Form Responses 1"}
  ];

  const IGNORE=["Not interested in Slot 1","Not interested in Slot 2","Not Interested",""];
  let eventData={};

  async function fetchData(){
    try {
      const rows = await Promise.all(
              SHEETS.map(s =>
                      fetch(`https://docs.google.com/spreadsheets/d/${s.id}/gviz/tq?sheet=${encodeURIComponent(s.name)}&t=${Date.now()}`)
                              .then(r => r.text())
                              .then(t => JSON.parse(t.match(/setResponse\(([\s\S]+)\);/)[1]).table.rows)
              )
      );
      processRows(rows.flat());
    } catch (e) {
      document.getElementById('eventTitle').textContent = "Error loading data. Check Sheet Privacy.";
    }
  }

  function processRows(rows){
    eventData={};
    rows.forEach(row=>{
      const name=row.c[2]?.v||"";
      const email=row.c[3]?.v||"";
      const phone=row.c[4]?.v||"";
      const college=row.c[7]?.v||"";

      [row.c[10]?.v, row.c[11]?.v].forEach(ev=>{
        if(ev && !IGNORE.includes(ev)){
          const obj={name, email, phone, college, event:ev};
          (eventData[ev] ||= []).push(obj);
        }
      });
    });
    populateEvents();
  }

  function populateEvents(){
    const select = document.getElementById('eventSelect');
    select.innerHTML='<option value="">Select Event</option>';
    Object.keys(eventData).sort().forEach(e=>{
      select.add(new Option(`${e} (${eventData[e].length})`, e));
    });
  }

  document.getElementById('eventSelect').onchange = function() {
    const ev = this.value;
    if(!ev) { document.getElementById('printArea').innerHTML=""; return; }
    document.getElementById('eventTitle').textContent = ev.toUpperCase() + " – ATTENDANCE SHEET";
    renderSheet(eventData[ev]);
  };

  function renderSheet(data){
    let html = `
      <table>
        <thead>
          <tr>
            <th style="width:30px">S.No</th>
            <th>Name</th>
            <th>College</th>
            <th>Phone Number</th>
            <th style="width:60px">Present</th>
          </tr>
        </thead>
        <tbody>`;

    data.forEach((s, i) => {
      html += `
        <tr>
          <td>${i + 1}</td>
          <td>${s.name}</td>
          <td>${s.college}</td>
          <td>${s.phone}</td>
          <td><div class="checkbox"></div></td>
        </tr>`;
    });

    html += `</tbody></table>`;

    // ADD COORDINATOR SIGNATURE ONLY ONCE AT THE END
    html += `
      <div class="final-footer">
        <div>
          <div class="sig-line">Coordinator Signature</div>
        </div>
      </div>`;

    document.getElementById('printArea').innerHTML = html;
  }

  fetchData();
</script>
</body>
</html>
